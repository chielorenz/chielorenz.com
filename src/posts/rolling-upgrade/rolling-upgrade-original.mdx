---
title: Rolling updrage™
excerpt: Or how we upgraded a 300k line PHP codebase while continuing the development of new features and bug fixing.
timestamp: 2024-05-14
published: true
---

import Image from "next/image";
import versionsSrc from "./symfony-versions.png";

# Rolling upgrade™

You find yourself in a small team, with four developers, having to respect the product roadmap, fix bugs, provide customer support and the need to update a codebase of 300k lines of code without stopping anything. How do you do it?

To meet the deadlines we could not put more than one developer to work on the update, and with just one person the update would have taken several weeks. Weeks in which the rest of the team would have continued to update the codebase with new features and bug fixes, in short a hell of merge conflicts.

The idea was therefore to completely bypass this problem by automating the update, so I dedicated part of my time, let's say 30%, to writing a procedure that had to be able to update the codebase with a click.

## The codebase

But what codebase was it? The codebase of the backend of a web app, with 300k lines of code, in PHP 5.6 with Symony 2.7, which had to be updated to PHP 8.1 with Symfony 6.4 (the latest at the time of the update). The app managed the connection to a database and its migrations, generated Excel files, created PDFs, sent emails, managed image uploads, managed customer charges, uploaded files to S3, connected to SOAP servers and more, the amount of vendors used was not at all trivial as you can imagine.

## The upgrade

Upgrading PHP wasn't particularly challenging, from 5.6 to 8.1 are two majors, PHP 6 doesn't exist. The procedure only had to check that the codebase didn't use deprecated syntax. The real problem was updating the vendors that all had to be updated to a version compatible with 8.1.

The work was then to go through all the vendors, figure out the correct version to use, look for a guide to upgrade and make sure the procedure made the changes requested. In some cases and vendors used were deprecated and not updated to support PHP 8.1, in these cases we had to choose an alternative and make sure the procedure replaced the old library.

Upgrading the Symfony framework was more complex, despite the excellent documentation provided for the version upgrade, there were many issues to deal with, such as changing the folder structure and namespaces, updating the configurations, introducing secrets, dependency injection via type-hint, changing the database migration system and certainly others that my brain has forgotten as a defense mechanism.

To go from Symfony 2.7 to 6.4 there are four major and 16 minor:

<Image src={versionsSrc} alt="symfony versions" />

We then consulted the upgrade guides for all intermediate releases to understand how they impacted our codebase and made sure the process made the necessary changes. These were mainly new configurations, different folder structures, and new best practices that, although not necessary, we decided to adopt anyway.

## The procedure

The procedure consisted of a bash script that cloned the codebase in a folder and copied the files to another folder using the new structure, updated them using a mix of techniques such as regex, rsync, find, sed and custom PHP scripts. Several docker containers, created by the procedure itself, were used to be able to execute composer and Symfony console commands. At each step the procedure committed the changes to have checkpoints for debugging.

Let's see some examples, this is a piece of the bash script:

```bash
log "Copy tests classes"
rsync -a "$S2_DIR/src/ApiBundle/Tests/Controller/" $S6_DIR/tests/Controller/
rsync -a "$S2_DIR/src/CoreBundle/Tests/Controller/" $S6_DIR/tests/Controller/
rsync -a "$S2_DIR/src/CoreBundle/Tests/Entity/" $S6_DIR/tests/Entity/
commit "ADD: Copy tests classes" $S6_DIR

log "Update entities"
find $S6_DIR/src/ $S6_DIR/tests/ $S6_DIR/config/ -type f -exec gsed -i -E -e 's/((Canvas|Api|Core|CRM|Cron|Desk|Export|Import|IncomeStatement|Migration)Bundle)\\+Entity/App\\Entity\\Core/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ $S6_DIR/config/ -type f -exec gsed -i -E -e 's/(Dashboard|Group|Integration)Bundle\\+Entity\\+Core/App\\Entity\\Core/g' {} +
commit "UPDATE: namespaces" $S6_DIR

log "Update entity manager injection to allow type-hintyng in services"
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/\$\bem\b/\$coreEm/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/->em\b/->coreEm/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/\$\bthis->em\b/\$this->coreEm/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/->get\("doctrine"\)->getManager\('"'"'access'"'"'\)/->get\('"'"'doctrine.orm.access_entity_manager'"'"'\)/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/->get\("doctrine"\)->getManager\('"'"'default'"'"'\)/->get\('"'"'doctrine.orm.core_entity_manager'"'"'\)/g' {} +
find $S6_DIR/src/ $S6_DIR/tests/ -type f -exec gsed -i -E -e 's/->get\('"'"'doctrine'"'"'\)->getManager\('"'"'default'"'"'\)/->get\('"'"'doctrine.orm.core_entity_manager'"'"'\)/g' {} +
commit "UPDATE: entity manager injection to allow type-hinting in services" $S6_DIR

log "Replace PHPExcel -> PhpSpreadsheet with rector"
docker exec upgrade-php-8 composer require --no-interaction --with-all-dependencies --working-dir=/var/www/api.s6 --dev rector/rector rector/rector-phpoffice
docker exec upgrade-php-8 /bin/ash -c "cd /var/www/api.s6/ && php bin/console cache:pool:clear cache.global_clearer" # clear cache
docker cp $CONFIG/rector.php upgrade-php-8:/var/www/api.s6/
docker cp $CONFIG/phpoffice upgrade-php-8:/var/www/api.s6/vendor
docker exec upgrade-php-8 /bin/ash -c "cd /var/www/api.s6/ && vendor/bin/rector process src"
docker exec upgrade-php-8 composer remove --no-interaction --with-all-dependencies --working-dir=/var/www/api.s6 --dev rector/rector rector/rector-phpoffice
commit "UPDATE: replace PHPExcel -> PhpSpreadsheet with rector" $S6_DIR
```

This is a piece of a PHP script that updates the controllers to continue working even with the new dependency injection via type-hint:

```php
...
// Find the class definition in the controller with a regex
// (use PREG_OFFSET_CAPTURE to get the match offset (in bytes))
$matchClass = '/class.*[\n\r]*{/';
preg_match($matchClass, $content, $matches, PREG_OFFSET_CAPTURE);
list($capture, $offset) = $matches[0];

$capturedLengh = strlen($capture); // lenght of the matched string
$insertPosition = $offset + $capturedLengh; // position where to insert the text
$parts = str_split($content, $insertPosition); // split the file content in the insert position
$beforeText = array_shift($parts); // this is the text befor the inset position
$afterText = implode($parts); // this is the text after the insert position

// Search all the container call like  $this->container->get(XXX) and extract the asked services.
$matchServices = '/\$this\s*->container\s*->get\(\s*(\'|")(?<service>[.\-\w]*)(\'|")\s*\)/';
preg_match_all($matchServices, $content, $matchedServices);
...
// The new text to intert
$glue = ",\n            "; // keep the spaces for indentation
$subscribers = implode($glue, $serviceDefinitions);
$newText = <<<EOF
    public static function getSubscribedServices(): array
    {
        return array_merge(parent::getSubscribedServices(), [{$subscribers}]);
    }
EOF;

// Join the final content and write it to the file
$newContent = $beforeText.$newText.$afterText;
$file = fopen($fullPath, "w");
fwrite($file, $newContent);
fclose($file);
...
```

By the end of the work the procedure consisted of a main bash script of over 1200 lines, and hundreds of lines of PHP script and yaml configuration files, all in over 500 commits.

## The day of the upgrade

It was about 20 months of work, not weeks, months. At some point, with enough testing and hope, we decided it was time to take the leap, so:

```bash
sh ./run.sh
# Diverse decine di minuti di attesa, non ricordo di preciso quanti
Done, checkout the codebase with symfony 6.4 and PHP 8.1 on $S6_DIR folder
```

We then took the entire folder generated by the procedure and replaced it with the old codebase, keeping the .git folder, and committed the changes, a commit that changed every single end of the codebase.

## Report

It was definitely not an easy task, at times we wondered if we would ever finish, but we also knew it was necessary to do it, so we continued.

The decision not to stop work on the product to do the update but to write a procedure that could do the update turned out to be a winning solution, in hindsight perhaps even the only possible solution. The overhead of having to understand how to update the codebase but not being able to do it directly but rather having to write a procedure to do it certainly had a big impact on the amount of work needed, on the other hand it made the update testable and replicable.

After the update we changed gear with development, PHP 8.1 had a significant increase in performance, getting rid of deprecated vendors made the codebase leaner and the adoption of the latest version of Symfony made several new tools available to us that were not accessible before.

## Lessons learned

We realized that as a team we were able to handle greater complexity than we thought. We realized that it was our fault to put ourselves in the situation we were in, with an out-of-date codebase, and that the effort to fix it is absolutely greater than the effort needed to keep it constantly updated.

Doing this upgrade I also learned many things, from unknown bash commands to how to read vendor upgrade guides, from how to manage a long task along with all the other necessary tasks to how not to give up on a task that seems to have no end but then, after 20 months, it ends.
